/*! @maps4html/web-map-custom-element 08-04-2023 */
/* (c) 2023 Open Source Geospatial Foundation - all rights reserved
 * This code is licensed under the GPL 2.0 license, available at the root
 * application directory.
 * Copyright (c) 2023 Canada Centrre for Mapping and Earth Observation, Natural
 * Resources Canada
 * Copyright © 2023 World Wide Web Consortium, (Massachusetts Institute of Technology, 
 * European Research Consortium for Informatics and Mathematics, Keio    
 * University, Beihang). All Rights Reserved. This work is distributed under the 
 * W3C® Software License [1] in the hope that it will be useful, but WITHOUT ANY 
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR 
 * A PARTICULAR PURPOSE.
 * [1] http://www.w3.org/Consortium/Legal/copyright-software
 * 
 */
class MapFeature extends HTMLElement{static get observedAttributes(){return["zoom"]}get zoom(){return+(this.hasAttribute("zoom")?this.getAttribute("zoom"):0)}set zoom(e){e=String.toString(parseInt(e,10));!isNaN(e)&&0<=e&&e<=25&&this.setAttribute("zoom",e)}get extent(){if(this.isConnected)return this._getFeatureExtent()}attributeChangedCallback(e,t,r){"zoom"===e&&t!==r&&this._layerParent&&(this._remove(),this._redraw())}constructor(){super()}connectedCallback(){this.parentNode.nodeType!==document.DOCUMENT_FRAGMENT_NODE&&"layer-"!==this.parentNode.tagName.toLowerCase()||(this._layerParent=this.parentNode._layer||this.parentNode.host._layer,this._map=this._layerParent._map,this._layerParent._layerEl.hasAttribute("data-moving")||(this._observer=new MutationObserver(t=>{for(let e=0;e<t.length;++e)this._remove(),this._redraw()}),this._observer.observe(this,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterData:!0}),this._featureLayer?this._groupEl=this._featureLayer.options.group:this._redraw()))}disconnectedCallback(){this._layerParent._layerEl.hasAttribute("data-moving")||(this._remove(),this._observer.disconnect())}_remove(){this._groupEl.isConnected&&this._groupEl.parentNode.removeChild(this._groupEl),this._featureLayer._map&&this._featureLayer._map.removeLayer(this._featureLayer),delete this._featureLayer,delete this._groupEl}_redraw(){let r=this.closest("map-meta[name=zoom]")?.getAttribute("content")?.split(",").find(e=>e.includes("value"))||0,o=this.closest(".map-meta[name=cs]")?.getAttribute("content")||"pcrs",e=this._layerParent._mapmlvectors;if(e){this._featureLayer=this._layerParent._mapmlvectors.addData(this,o,+r),this._featureLayer.addTo(this._map);let e=this._featureLayer._layers;for(const t in e)e[t].addTo(this._map);this._groupEl=this._featureLayer.options.group}else this._layerParent.once("attachmapml",function(){this._featureLayer=this._layerParent._mapmlvectors.addData(this,o,+r),this._featureLayer.addTo(this._map);let e=this._featureLayer._layers;for(const t in e)e[t].addTo(this._map);this._groupEl=this._featureLayer.options.group},this)}geometryToGeoJSON(a){let i={},n=0;var l,u=this._featureLayer._layers;for(l in u){let e=i[n]={},t=this.querySelector("map-properties"),r=null,o=null,s=!1;"EPSG:3857"===this._map.options.crs.code&&"EPSG:4326"===this._map.options.crs.code||(r=new proj4.Proj(this._map.options.crs.code),o=new proj4.Proj("EPSG:4326"),s=!0),e.geometry=M._geometry2geojson(u[l]._markup,r,o,s),a?e.properties=a(t):null!==t.querySelector("table")?e.properties=M._table2properties(t.querySelector("table")):e.properties={prop0:t.innerHTML.replace(/(<([^>]+)>)/gi,"").replace(/\s/g,"")},n++}return i}_getFeatureExtent(){let e=this._map,t=this.querySelector("map-geometry"),r=this.closest(".map-meta[name=cs]")?.getAttribute("content")||"pcrs",o=t.getAttribute("cs")||r,s=t.querySelectorAll("map-point, map-linestring, map-polygon, map-multipoint, map-multilinestring"),a=[1/0,1/0,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(var i of s){var n=i.querySelectorAll("map-coordinates");for(let e=0;e<n.length;++e)!function(e,t){var r=t.innerHTML.split(" ");switch(e.tagName){case"MAP-POINT":a=M._updateExtent(a,+r[0],+r[1]);break;case"MAP-LINESTRING":case"MAP-POLYGON":case"MAP-MULTIPOINT":case"MAP-MULTILINESTRING":for(let e=0;e<r.length;e+=2)a=M._updateExtent(a,+r[e],+r[e+1])}}(i,n[e])}var l=L.point(a[0],a[1]),u=L.point(a[2],a[3]),u=M.boundsToPCRSBounds(L.bounds(l,u),e.getZoom(),e.options.projection,o);return M._convertAndFormatPCRS(u,e)}click(e){let t=this._groupEl,r=t.getBoundingClientRect();if(e=e||new MouseEvent("mousedown",{clientX:r.x+r.width/2,clientY:r.y+r.height/2,button:0}),"function"==typeof this.onclick)this.onclick(this,e);else{var o=this.querySelector("map-properties");if(this.focus(e),"link"===t.getAttribute("role")){for(var s of t.children)s.mousedown.call(this._featureLayer,e),s.mouseup.call(this._featureLayer,e);document.dispatchEvent(new MouseEvent("click",{bubbles:!1}))}o&&this.isConnected&&(this._featureLayer.isPopupOpen()?this._featureLayer.closePopup():this._featureLayer.openPopup())}}focus(e){let r=this._groupEl,o=this._featureLayer,t=r.getBoundingClientRect();e=e||new MouseEvent("mousedown",{clientX:t.x+t.width/2,clientY:t.y+t.height/2,button:0}),"function"==typeof this.onfocus?this.onfocus(this,e):"button"!==r.getAttribute("role")&&"link"!==r.getAttribute("role")&&"0"!==r.getAttribute("tabindex")||(r.classList.toggle("focus"),document.addEventListener("click",function e(t){t.preventDefault();t.stopPropagation();r.classList.contains("focus")&&r.classList.remove("focus");o?.isPopupOpen()&&o.closePopup();document.removeEventListener("click",e)},!0))}}export{MapFeature};
//# sourceMappingURL=map-feature.js.map