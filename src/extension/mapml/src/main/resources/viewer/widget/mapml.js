/*! @maps4html/web-map-custom-element 28-04-2023 */
/* (c) 2023 Open Source Geospatial Foundation - all rights reserved
 * This code is licensed under the GPL 2.0 license, available at the root
 * application directory.
 * Copyright (c) 2023 Canada Centrre for Mapping and Earth Observation, Natural
 * Resources Canada
 * Copyright © 2023 World Wide Web Consortium, (Massachusetts Institute of Technology, 
 * European Research Consortium for Informatics and Mathematics, Keio    
 * University, Beihang). All Rights Reserved. This work is distributed under the 
 * W3C® Software License [1] in the hope that it will be useful, but WITHOUT ANY 
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR 
 * A PARTICULAR PURPOSE.
 * [1] http://www.w3.org/Consortium/Legal/copyright-software
 * 
 */
!function(){"use strict";function t(t){return new o(t)}function e(t,e){return new i(t,e)}var o=L.GridLayer.extend({initialize:function(t){this.zoomBounds=this._getZoomBounds(t.tileContainer,t.maxZoomBound),L.extend(t,this.zoomBounds),L.setOptions(this,t),this._groups=this._groupTiles(this.options.tileContainer.getElementsByTagName("map-tile"))},onAdd:function(){this._bounds=this._getLayerBounds(this._groups,this._map.options.projection),this.layerBounds=this._bounds[Object.keys(this._bounds)[0]];for(var t of Object.keys(this._bounds))this.layerBounds.extend(this._bounds[t].min),this.layerBounds.extend(this._bounds[t].max);L.GridLayer.prototype.onAdd.call(this,this._map),this._handleMoveEnd()},getEvents:function(){let t=L.GridLayer.prototype.getEvents.call(this,this._map);return this._parentOnMoveEnd=t.moveend,t.moveend=this._handleMoveEnd,t.move=()=>{},t},_handleMoveEnd:function(t){var e=this._map.getZoom();let o=e;o=o>this.options.maxNativeZoom?this.options.maxNativeZoom:o,o=o<this.options.minNativeZoom?this.options.minNativeZoom:o,this.isVisible=e<=this.zoomBounds.maxZoom&&e>=this.zoomBounds.minZoom&&this._bounds[o]&&this._bounds[o].overlaps(M.pixelToPCRSBounds(this._map.getPixelBounds(),this._map.getZoom(),this._map.options.projection)),this.isVisible&&this._parentOnMoveEnd()},_isValidTile(t){return this._groups[this._tileCoordsToKey(t)]},createTile:function(t){let o=this._groups[this._tileCoordsToKey(t)]||[],i=document.createElement("map-tile"),n=this.getTileSize();i.setAttribute("col",t.x),i.setAttribute("row",t.y),i.setAttribute("zoom",t.z);for(let e=0;e<o.length;e++){let t=document.createElement("img");t.width=n.x,t.height=n.y,t.alt="",t.setAttribute("role","presentation"),t.src=o[e].src,i.appendChild(t)}return i},_getLayerBounds:function(t,e){let o={},i=M[e].options.crs.tile.bounds.max.x;for(var n in t){let t=n.split(":"),e={};e.x=+t[0]*i,e.y=+t[1]*i,e.z=+t[2],t[2]in o?(o[t[2]].extend(L.point(e.x,e.y)),o[t[2]].extend(L.point(e.x+i,e.y+i))):o[t[2]]=L.bounds(L.point(e.x,e.y),L.point(e.x+i,e.y+i))}for(var a in o){var r=+a;o[a]=M.pixelToPCRSBounds(o[a],r,e)}return o},_getZoomBounds:function(t,e){if(!t)return null;let o=M._metaContentToObject(t.getElementsByTagName("map-tiles")[0].getAttribute("zoom")),i={},n=t.getElementsByTagName("map-tile");i.nativeZoom=+o.value||0,i.maxNativeZoom=0,i.minNativeZoom=e;for(let e=0;e<n.length;e++){let t=+n[e].getAttribute("zoom");n[e].getAttribute("zoom")||(t=i.nativeZoom),i.minNativeZoom=Math.min(i.minNativeZoom,t),i.maxNativeZoom=Math.max(i.maxNativeZoom,t)}return i.minZoom=i.minNativeZoom-2<=0?0:i.minNativeZoom-2,i.maxZoom=e,o.min&&(i.minZoom=+o.min<i.minNativeZoom-2?i.minNativeZoom-2:+o.min),o.max&&(i.maxZoom=+o.max),i},_groupTiles:function(o){let i={};for(let e=0;e<o.length;e++){let t={};t.row=+o[e].getAttribute("row"),t.col=+o[e].getAttribute("col"),t.zoom=+o[e].getAttribute("zoom")||this.options.nativeZoom,t.src=o[e].getAttribute("src");var n=t.col+":"+t.row+":"+t.zoom;n in i?i[n].push(t):i[n]=[t]}return i}}),i=L.Control.Layers.extend({options:{autoZIndex:!1,sortLayers:!0,sortFunction:function(t,e){return t.options.zIndex<e.options.zIndex?-1:t.options.zIndex>e.options.zIndex?1:0}},initialize:function(t,e){for(var o in L.setOptions(this,e),this._layerControlInputs=[],this._layers=[],this._lastZIndex=0,this._handlingClick=!1,t)this._addLayer(t[o],o,!0)},onAdd:function(){return this._initLayout(),this._map.on("validate",this._validateInput,this),L.DomEvent.on(this.options.mapEl,"layerchange",this._validateInput,this),L.DomEvent.on(this._container.getElementsByTagName("a")[0],"keydown",this._focusFirstLayer,this._container),L.DomEvent.on(this._container,"contextmenu",this._preventDefaultContextMenu,this),this._update(),this._layers.length<1&&!this._map._showControls?this._container.setAttribute("hidden",""):this._map._showControls=!0,this._container},onRemove:function(t){t.off("validate",this._validateInput,this),L.DomEvent.off(this._container.getElementsByTagName("a")[0],"keydown",this._focusFirstLayer,this._container);for(var e=0;e<this._layers.length;e++)this._layers[e].layer.off("add remove",this._onLayerChange,this),this._layers[e].layer.off("extentload",this._validateInput,this)},addOrUpdateOverlay:function(t,e){for(var o=!1,i=0;i<this._layers.length;i++)if(this._layers[i].layer===t){o=!0,this._layers[i].name=e;break}return o||this.addOverlay(t,e),0<this._layers.length&&(this._container.removeAttribute("hidden"),this._map._showControls=!0),this._map?this._update():this},removeLayer:function(t){L.Control.Layers.prototype.removeLayer.call(this,t),0===this._layers.length&&this._container.setAttribute("hidden","")},_validateInput:function(t){for(let i=0;i<this._layers.length;i++)if(this._layers[i].input.labels[0]){let t=this._layers[i].input.labels[0].getElementsByTagName("span"),e=this._layers[i].input.labels[0].getElementsByTagName("input");if(e[0].checked=this._layers[i].layer._layerEl.checked,this._layers[i].layer._layerEl.disabled&&this._layers[i].layer._layerEl.checked?(e[0].closest("fieldset").disabled=!0,t[0].style.fontStyle="italic"):(e[0].closest("fieldset").disabled=!1,t[0].style.fontStyle="normal"),this._layers[i].layer._extent&&this._layers[i].layer._extent._mapExtents)for(let o=0;o<this._layers[i].layer._extent._mapExtents.length;o++){let t=this._layers[i].layer._extent._mapExtents[o].extentAnatomy,e=t.getElementsByClassName("mapml-layer-item-name")[0];this._layers[i].layer._extent._mapExtents[o].disabled&&this._layers[i].layer._extent._mapExtents[o].checked?(e.style.fontStyle="italic",t.disabled=!0):(e.style.fontStyle="normal",t.disabled=!1)}}},_focusFirstLayer:function(t){var e;"Enter"!==t.key||"leaflet-control-layers leaflet-control leaflet-control-layers-expanded"!==this.className||(e=this.children[1].children[2].children[0].children[0].children[0].children[0])&&setTimeout(()=>e.focus(),0)},_withinZoomBounds:function(t,e){return e.min<=t&&t<=e.max},_addItem:function(t){var e=t.layer.getLayerUserControlsHTML();return t.input=e.querySelector("input.leaflet-control-layers-selector"),this._layerControlInputs.push(t.input),t.input.layerId=L.stamp(t.layer),L.DomEvent.on(t.input,"click",this._onInputClick,this),t.layer.on("extentload",this._validateInput,this),this._overlaysList.appendChild(e),e},collapse:function(t){return"SELECT"===t.target.tagName||t.relatedTarget&&t.relatedTarget.parentElement&&("mapml-contextmenu mapml-layer-menu"===t.relatedTarget.className||"mapml-contextmenu mapml-layer-menu"===t.relatedTarget.parentElement.className)||this._map&&"block"===this._map.contextMenu._layerMenu.style.display||(L.DomUtil.removeClass(this._container,"leaflet-control-layers-expanded"),"touch"===t.originalEvent?.pointerType&&(this._container._isExpanded=!1)),this},_preventDefaultContextMenu:function(t){var e=this._map.mouseEventToLatLng(t),o=this._map.mouseEventToContainerPoint(t);t.preventDefault(),this._container._isExpanded||"touch"!==t.pointerType?this._map.fire("contextmenu",{originalEvent:t,containerPoint:o,latlng:e}):this._container._isExpanded=!0}});const I="OSMTILE",d="TILEMATRIX",k="mapmltemplatedtileplaceholder";function n(t,e){return new p(t,e)}function a(t,e){return new h(t,e)}function r(t,e){return new _(t,e)}function s(t,e){return new y(t,e)}function l(t,e){return new f(t,e)}function m(t,e,o,i,n,a){return new g(t,e,o,i,n,a)}function u(t,e,o){return t||e?new x(t,e,o):null}function c(){return new b}var p=L.FeatureGroup.extend({initialize:function(t,e){var o;L.setOptions(this,e),this.options.static&&(this._container=L.DomUtil.create("div","leaflet-layer",this.options.pane),L.DomUtil.addClass(this._container,"leaflet-pane mapml-vector-container"),L.setOptions(this.options.renderer,{pane:this._container})),this._layers={},this.options.query&&(this._mapmlFeatures=t.features||t,this.isVisible=!0,o=this._getNativeVariables(t),this.options.nativeZoom=o.zoom,this.options.nativeCS=o.cs),t&&!this.options.query&&(o=this._getNativeVariables(t),!t.querySelector("map-extent")&&t.querySelector("map-feature")&&this.options.static&&(this._features={},this._staticFeature=!0,this.isVisible=!0,this.zoomBounds=this._getZoomBounds(t,o.zoom),this.layerBounds=this._getLayerBounds(t),L.extend(this.options,this.zoomBounds)),this.addData(t,o.cs,o.zoom),this._staticFeature&&(this._resetFeatures(),this.options._leafletLayer._map._addZoomLimit(this)))},onAdd:function(t){L.FeatureGroup.prototype.onAdd.call(this,t),this._mapmlFeatures&&t.on("featurepagination",this.showPaginationFeature,this)},onRemove:function(t){this._mapmlFeatures&&(t.off("featurepagination",this.showPaginationFeature,this),delete this._mapmlFeatures,L.DomUtil.remove(this._container)),L.FeatureGroup.prototype.onRemove.call(this,t),this._map.featureIndex.cleanIndex()},getEvents:function(){return this._staticFeature?{moveend:this._handleMoveEnd,zoomend:this._handleZoomEnd}:{}},showPaginationFeature:function(e){if(this.options.query&&this._mapmlFeatures[e.i]){let t=this._mapmlFeatures[e.i];t._extentEl.shadowRoot.firstChild?.remove(),this.clearLayers(),t._featureGroup=this.addData(t,this.options.nativeCS,this.options.nativeZoom),t._extentEl.shadowRoot.appendChild(t),e.popup._navigationBar.querySelector("p").innerText=e.i+1+"/"+this.options._leafletLayer._totalFeatureCount,e.popup._content.querySelector("iframe").setAttribute("sandbox","allow-same-origin allow-forms"),e.popup._content.querySelector("iframe").srcdoc=t.querySelector("map-properties").innerHTML,this._map.fire("attachZoomLink",{i:e.i,currFeature:t}),this._map.once("popupclose",function(t){this.shadowRoot.innerHTML=""},t._extentEl)}},_getNativeVariables:function(t){return{zoom:t.querySelector&&t.querySelector("map-meta[name=zoom]")&&+M._metaContentToObject(t.querySelector("map-meta[name=zoom]").getAttribute("content")).value||0,cs:t.querySelector&&t.querySelector("map-meta[name=cs]")&&M._metaContentToObject(t.querySelector("map-meta[name=cs]").getAttribute("content")).content||"PCRS"}},_handleMoveEnd:function(){var t=this._map.getZoom(),e=t<=this.zoomBounds.maxZoom&&t>=this.zoomBounds.minZoom;this.isVisible=e&&this._layers&&this.layerBounds&&this.layerBounds.overlaps(M.pixelToPCRSBounds(this._map.getPixelBounds(),t,this._map.options.projection)),this._removeCSS()},_handleZoomEnd:function(t){var e=this._map.getZoom();e>this.zoomBounds.maxZoom||e<this.zoomBounds.minZoom?this.clearLayers():this._resetFeatures()},_getLayerBounds:function(t){if(!t)return null;let o=d,i=t.querySelector("map-meta[name=projection]")&&M._metaContentToObject(t.querySelector("map-meta[name=projection]").getAttribute("content")).content.toUpperCase()||I;try{var n=t.querySelector("map-meta[name=extent]")&&M._metaContentToObject(t.querySelector("map-meta[name=extent]").getAttribute("content")),a=n.zoom||0;let e=Object.keys(n);for(let t=0;t<e.length;t++)if(!e[t].includes("zoom")){o=M.axisToCS(e[t].split("-")[2]);break}var r=M.csToAxes(o);return M.boundsToPCRSBounds(L.bounds(L.point(+n["top-left-"+r[0]],+n["top-left-"+r[1]]),L.point(+n["bottom-right-"+r[0]],+n["bottom-right-"+r[1]])),a,i,o)}catch(t){return M.boundsToPCRSBounds(M[i].options.crs.tilematrix.bounds(0),0,i,o)}},_resetFeatures:function(){this.clearLayers(),this._map&&this._map.featureIndex.cleanIndex();let i=this._map||this.options._leafletLayer._map;if(this._features)for(var n in this._features)for(let o=0;o<this._features[n].length;o++){let t=this._features[n][o],e=t._checkRender(i.getZoom(),this.zoomBounds.minZoom,this.zoomBounds.maxZoom);e&&this.addLayer(t)}},_setZoomTransform:function(t,e){var o=this._map.getZoomScale(this._map.getZoom(),e),t=t.multiplyBy(o).subtract(this._map._getNewPixelOrigin(t,this._map.getZoom())).round();any3d?L.setTransform(this._layers[e],t,o):L.setPosition(this._layers[e],t)},_getZoomBounds:function(t,o){if(!t)return null;let i=100,n=0,a=t.querySelectorAll("map-feature"),e,r;for(let e=0;e<a.length;e++){let t=+a[e].getAttribute("zoom");a[e].getAttribute("zoom")||(t=o),n=Math.max(n,t),i=Math.min(i,t)}try{r=M._metaContentToObject(t.querySelector("map-meta[name=projection]").getAttribute("content")).content,e=M._metaContentToObject(t.querySelector("map-meta[name=zoom]").getAttribute("content"))}catch(t){return{minZoom:0,maxZoom:M[r||I].options.resolutions.length-1,minNativeZoom:i,maxNativeZoom:n}}return{minZoom:+e.min,maxZoom:+e.max,minNativeZoom:i,maxNativeZoom:n}},addData:function(i,n,a){var t,e,o,r=i.nodeType===Node.DOCUMENT_NODE||"LAYER-"===i.nodeName?i.getElementsByTagName("map-feature"):null;if((i.nodeType===Node.DOCUMENT_NODE?i.querySelector("map-link[rel=stylesheet],map-style"):null)&&(s=i.querySelector("map-base")&&i.querySelector("map-base").hasAttribute("href")?new URL(i.querySelector("map-base").getAttribute("href")).href:i.URL,M._parseStylesheetAsHTML(i,s,this._container)),r){for(t=0,e=r.length;t<e;t++)(o=r[t]).getElementsByTagName("map-geometry").length&&o.getElementsByTagName("map-coordinates").length&&(i.nodeType===Node.DOCUMENT_NODE?(o._DOMnode||(o._DOMnode=o.cloneNode(!0)),o._DOMnode._featureGroup=this.addData(o._DOMnode,n,a)):o._featureGroup=this.addData(o,n,a));return this}var s=this.options;if(!s.filter||s.filter(i)){i.classList.length&&(s.className=i.classList.value);let t=i.getAttribute("zoom")||a,e=i.querySelector("map-featurecaption");e=e?e.innerHTML:"Feature",i.querySelector("map-properties")&&(s.properties=document.createElement("div"),s.properties.classList.add("mapml-popup-content"),s.properties.insertAdjacentHTML("afterbegin",i.querySelector("map-properties").innerHTML));let o=this.geometryToLayer(i,s,n,+t,e);if(o)return!o.options.color&&i.hasAttribute("class")&&(o.options.className=i.getAttribute("class")),o.defaultOptions=o.options,this.resetStyle(o),s.onEachFeature&&o.bindTooltip(e,{interactive:!0,sticky:!0}),this._staticFeature?(s=i.getAttribute("zoom")||a)in this._features?this._features[s].push(o):this._features[s]=[o]:this.addLayer(o),"MAP-FEATURE"===i.tagName.toUpperCase()&&(i._groupEl=o.options.group),o}},resetStyle:function(t){var e=this.options.style;e&&(L.Util.extend(t.options,t.defaultOptions),this._setLayerStyle(t,e))},setStyle:function(e){this.eachLayer(function(t){this._setLayerStyle(t,e)},this)},_setLayerStyle:function(t,e){"function"==typeof e&&(e=e(t.feature)),t.setStyle&&t.setStyle(e)},_removeCSS:function(){var e=this._container.querySelectorAll("link[rel=stylesheet],style");for(let t=0;t<e.length;t++)this._container.removeChild(e[t])},geometryToLayer:function(o,i,t,n,a){let r="MAP-FEATURE"===o.tagName.toUpperCase()?o.getElementsByTagName("map-geometry")[0]:o,s=r?.getAttribute("cs")||t,l=[],m=L.SVG.create("g"),u=Object.assign({},i);if(r){for(var c of r.querySelectorAll("map-polygon, map-linestring, map-multilinestring, map-point, map-multipoint"))l.push(M.feature(c,Object.assign(u,{nativeCS:s,nativeZoom:n,projection:this.options.projection,featureID:o.id,group:m,wrappers:this._getGeometryParents(c.parentElement),featureLayer:this,_leafletLayer:this.options._leafletLayer})));let t={group:m,mapmlFeature:o,featureID:o.id,accessibleTitle:a,onEachFeature:i.onEachFeature,properties:i.properties,_leafletLayer:this.options._leafletLayer},e=r.querySelector("map-multipolygon")||r.querySelector("map-geometrycollection");return e&&(t.wrappers=this._getGeometryParents(e.parentElement)),M.featureGroup(l,t)}},_getGeometryParents:function(t,e=[]){return t&&"MAP-GEOMETRY"!==t.tagName.toUpperCase()?"MAP-MULTIPOLYGON"===t.tagName.toUpperCase()||"MAP-GEOMETRYCOLLECTION"===t.tagName.toUpperCase()?this._getGeometryParents(t.parentElement,e):this._getGeometryParents(t.parentElement,e.concat([t])):e}}),h=L.TileLayer.extend({initialize:function(t,e){var o=M._extractInputBounds(t);this.zoomBounds=o.zoomBounds,this.extentBounds=o.bounds,this.isVisible=!0,L.extend(e,this.zoomBounds),e.tms=t.tms,delete e.opacity,L.setOptions(this,e),this._setUpTileTemplateVars(t),this._template=t,this._initContainer(),L.TileLayer.prototype.initialize.call(this,t.template,L.extend(e,{pane:this._container}))},onAdd:function(){this._map._addZoomLimit(this),L.TileLayer.prototype.onAdd.call(this,this._map),this._handleMoveEnd()},getEvents:function(){let t=L.TileLayer.prototype.getEvents.call(this,this._map);return this._parentOnMoveEnd=t.moveend,t.moveend=this._handleMoveEnd,t},_initContainer:function(){this._container||(this._container=L.DomUtil.create("div","leaflet-layer",this.options.pane),L.DomUtil.addClass(this._container,"mapml-templated-tile-container"),this._updateZIndex())},_handleMoveEnd:function(t){var e=this._map.getZoom(),o=M.pixelToPCRSBounds(this._map.getPixelBounds(),e,this._map.options.projection);this.isVisible=e<=this.options.maxZoom&&e>=this.options.minZoom&&this.extentBounds.overlaps(o),this.isVisible&&this._parentOnMoveEnd()},createTile:function(e){let o=document.createElement("DIV"),i=this.getTileSize();if(L.DomUtil.addClass(o,"mapml-tile-group"),L.DomUtil.addClass(o,"leaflet-tile"),this._template.linkEl.dispatchEvent(new CustomEvent("tileloadstart",{detail:{x:e.x,y:e.y,zoom:e.z,appendTile:t=>{o.appendChild(t)}}})),this._template.type.startsWith("image/")){let t=L.TileLayer.prototype.createTile.call(this,e,function(){});t.width=i.x,t.height=i.y,o.appendChild(t)}else this._url.includes(k)||this._fetchTile(e,o);return o},_mapmlTileReady:function(t){L.DomUtil.addClass(t,"leaflet-tile-loaded")},getPane:function(){return this.options.pane},_fetchTile:function(e,o){fetch(this.getTileUrl(e),{redirect:"follow"}).then(function(t){return 200<=t.status&&t.status<300?Promise.resolve(t):(console.log("Looks like there was a problem. Status Code: "+t.status),Promise.reject(t))}).then(function(t){return t.text()}).then(t=>{return(new DOMParser).parseFromString(t,"application/xml")}).then(t=>{this._createFeatures(t,e,o),this._mapmlTileReady(o)}).catch(t=>{console.log("Error Creating Tile")})},_createFeatures:function(t,e,o){var i;t.querySelector("map-link[rel=stylesheet],map-style")&&(i=t.querySelector("map-base")&&t.querySelector("map-base").hasAttribute("href")?new URL(t.querySelector("map-base").getAttribute("href")).href:t.URL,M._parseStylesheetAsHTML(t,i,o));let n=L.SVG.create("svg"),a=L.SVG.create("g"),r=this._map.options.crs.options.crs.tile.bounds.max.x,s=e.x*r,l=e.y*r;var m,u=M.featureLayer(t,{projection:this._map.options.projection,static:!1,interactive:!1});for(m in u._layers)for(var c in u._layers[m]._layers){let t=u._layers[m]._layers[c];M.FeatureRenderer.prototype._initPath(t,!1),t._project(this._map,L.point([s,l]),e.z),M.FeatureRenderer.prototype._addPath(t,a,!1),M.FeatureRenderer.prototype._updateFeature(t)}n.setAttribute("width",r.toString()),n.setAttribute("height",r.toString()),n.appendChild(a),o.appendChild(n)},getTileUrl:function(t){if(t.z>=this._template.tilematrix.bounds.length||!this._template.tilematrix.bounds[t.z].contains(t))return"";var e,o={},i=this._template.linkEl,n=i.zoomInput;for(e in o[this._template.tilematrix.col.name]=t.x,o[this._template.tilematrix.row.name]=t.y,n&&i.hasAttribute("tref")&&i.getAttribute("tref").includes(`{${n.getAttribute("name")}}`)&&(o[this._template.zoom.name]=this._getZoomForUrl()),o[this._template.pcrs.easting.left]=this._tileMatrixToPCRSPosition(t,"top-left").x,o[this._template.pcrs.easting.right]=this._tileMatrixToPCRSPosition(t,"top-right").x,o[this._template.pcrs.northing.top]=this._tileMatrixToPCRSPosition(t,"top-left").y,o[this._template.pcrs.northing.bottom]=this._tileMatrixToPCRSPosition(t,"bottom-left").y,this._template.tile)["row","col","zoom","left","right","top","bottom"].indexOf(e)<0&&(o[e]=this._template.tile[e]);return this._map&&!this._map.options.crs.infinite&&(t=this._globalTileRange.max.y-t.y,this.options.tms&&(o[this._template.tilematrix.row.name]=t)),o.r=this.options.detectRetina&&L.Browser.retina&&0<this.options.maxZoom?"@2x":"",L.Util.template(this._url,o)},_tileMatrixToPCRSPosition:function(t,e){var o=this._map.options.crs,i=this.getTileSize(),n=t.scaleBy(i),a=n.add(i),i=n.add(Math.floor(i/2)),r=o.transformation.untransform(n,o.scale(t.z)),s=o.transformation.untransform(a,o.scale(t.z)),l=o.transformation.untransform(i,o.scale(t.z)),m=null;switch(e){case"top-left":m=r;break;case"bottom-left":m=new L.Point(r.x,s.y);break;case"center-left":m=new L.Point(r.x,l.y);break;case"top-right":m=new L.Point(s.x,r.y);break;case"bottom-right":m=s;break;case"center-right":m=new L.Point(s.x,l.y);break;case"top-center":m=new L.Point(l.x,r.y);break;case"bottom-center":m=new L.Point(l.x,s.y);break;case"center":m=l}return m},_setUpTileTemplateVars:function(t){t.tile={};for(var e,o,i,n,a,r=t.values,s=this.options.crs.options,l=0;l<t.values.length;l++){var m=r[l].getAttribute("type"),u=r[l].getAttribute("units"),c=r[l].getAttribute("axis"),p=r[l].getAttribute("name"),h=r[l].getAttribute("position"),d="map-select"===r[l].tagName.toLowerCase(),_=r[l].getAttribute("value"),y=r[l].getAttribute("min"),f=r[l].getAttribute("max");if("location"===m&&"tilematrix"===u)switch(c){case"column":a={name:p,min:s.crs.tilematrix.horizontal.min,max:s.crs.tilematrix.horizontal.max(s.resolutions.length-1)},isNaN(Number.parseFloat(y))||(a.min=Number.parseFloat(y)),isNaN(Number.parseFloat(f))||(a.max=Number.parseFloat(f));break;case"row":n={name:p,min:s.crs.tilematrix.vertical.min,max:s.crs.tilematrix.vertical.max(s.resolutions.length-1)},isNaN(Number.parseFloat(y))||(n.min=Number.parseFloat(y)),isNaN(Number.parseFloat(f))||(n.max=Number.parseFloat(f));break;case"longitude":case"easting":o=o||{min:s.crs.pcrs.horizontal.min,max:s.crs.pcrs.horizontal.max},isNaN(Number.parseFloat(y))||(o.min=Number.parseFloat(y)),isNaN(Number.parseFloat(f))||(o.max=Number.parseFloat(f)),h&&(h.match(/.*?-left/i)?o.left=p:h.match(/.*?-right/i)&&(o.right=p));break;case"latitude":case"northing":i=i||{min:s.crs.pcrs.vertical.min,max:s.crs.pcrs.vertical.max},isNaN(Number.parseFloat(y))||(i.min=Number.parseFloat(y)),isNaN(Number.parseFloat(f))||(i.max=Number.parseFloat(f)),h&&(h.match(/top-.*?/i)?i.top=p:h.match(/bottom-.*?/i)&&(i.bottom=p))}else if(m&&"zoom"===m.toLowerCase())e={name:p,min:0,max:s.resolutions.length,value:s.resolutions.length},!isNaN(Number.parseInt(_,10))&&Number.parseInt(_,10)>=e.min&&Number.parseInt(_,10)<=e.max?e.value=Number.parseInt(_,10):e.value=e.max,!isNaN(Number.parseInt(y,10))&&Number.parseInt(y,10)>=e.min&&Number.parseInt(y,10)<=e.max&&(e.min=Number.parseInt(y,10)),!isNaN(Number.parseInt(f,10))&&Number.parseInt(f,10)>=e.min&&Number.parseInt(f,10)<=e.max&&(e.max=Number.parseInt(f,10)),t.zoom=e;else if(d){const S=r[l].htmlselect;t.tile[p]=function(){return S.value}}else{const I=r[l];t.tile[p]=function(){return I.getAttribute("value")}}}function g(t,e){return x.transform(t,v(e)).divideBy(b).floor()}var x=this.options.crs.transformation,b=this.options.crs.options.crs.tile.bounds.max.x,v=L.bind(this.options.crs.scale,this.options.crs);o&&i?(t.pcrs={},t.pcrs.bounds=L.bounds([o.min,i.min],[o.max,i.max]),t.pcrs.easting=o,t.pcrs.northing=i):a&&n&&!isNaN(e.value)?(t.pcrs||(t.pcrs={},t.pcrs.easting="",t.pcrs.northing=""),t.pcrs.bounds=M.boundsToPCRSBounds(L.bounds(L.point([a.min,n.min]),L.point([a.max,n.max])),e.value,this.options.crs,M.axisToCS("column")),t.tilematrix={},t.tilematrix.col=a,t.tilematrix.row=n):console.log("Unable to determine bounds for tile template: "+t.template),t.tilematrix||(t.tilematrix={},t.tilematrix.col={},t.tilematrix.row={}),t.tilematrix.bounds=[];for(var E=t.pcrs.bounds,C=t.zoom?t.zoom.min:0,A=t.zoom?t.zoom.max:s.resolutions.length,T=0;T<=A;T++)t.tilematrix.bounds[T]=C<=T?L.bounds(g(E.min,T),g(E.max,T)):L.bounds(L.point([-1,-1]),L.point([-1,-1]))},_clampZoom:function(t){var e=L.GridLayer.prototype._clampZoom.call(this,t);return this._template.step>this.zoomBounds.maxNativeZoom&&(this._template.step=this.zoomBounds.maxNativeZoom),t!==e?t=e:t%this._template.step!=0&&(t=Math.floor(t/this._template.step)*this._template.step),t}}),_=L.Layer.extend({initialize:function(t,e){this._templates=t,L.setOptions(this,e),this._container=L.DomUtil.create("div","leaflet-layer",e.pane),this._container.style.opacity=this.options.opacity,L.DomUtil.addClass(this._container,"mapml-templatedlayer-container");for(var o,i=0;i<t.length;i++)"tile"===t[i].rel?(this.setZIndex(e.extentZIndex),this._templates[i].layer=M.templatedTileLayer(t[i],L.Util.extend(e,{errorTileUrl:"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",zIndex:e.extentZIndex,pane:this._container}))):"image"===t[i].rel?(this.setZIndex(e.extentZIndex),this._templates[i].layer=M.templatedImageLayer(t[i],L.Util.extend(e,{zIndex:e.extentZIndex,pane:this._container}))):"features"===t[i].rel?(this.setZIndex(e.extentZIndex),this._templates[i].layer=M.templatedFeaturesLayer(t[i],L.Util.extend(e,{zIndex:e.extentZIndex,pane:this._container}))):"query"===t[i].rel&&(this.hasSetBoundsHandler=!0,this._queries||(this._queries=[]),o=M._extractInputBounds(t[i]),t[i].extentBounds=o.bounds,t[i].zoomBounds=o.zoomBounds,t[i]._extentEl=this.options.extentEl,this._queries.push(L.extend(t[i],this._setupQueryVars(t[i]))))},getEvents:function(){return{zoomstart:this._onZoomStart}},redraw:function(){this.closePopup();for(var t=0;t<this._templates.length;t++)"tile"!==this._templates[t].rel&&"image"!==this._templates[t].rel&&"features"!==this._templates[t].rel||this._templates[t].layer.redraw()},_onZoomStart:function(){this.closePopup()},_setupQueryVars:function(t){for(var e={query:{}},o=t.values,i=0;i<t.values.length;i++){var n=o[i].getAttribute("type"),a=o[i].getAttribute("units"),r=o[i].getAttribute("axis"),s=o[i].getAttribute("name"),l=o[i].getAttribute("position"),m=o[i].getAttribute("rel"),u="map-select"===o[i].tagName.toLowerCase();if("width"===n)e.query.width=s;else if("height"===n)e.query.height=s;else if("location"===n)switch(r){case"x":case"y":case"column":case"row":e.query[r]=s;break;case"longitude":case"easting":l?l.match(/.*?-left/i)?"pixel"===m?e.query.pixelleft=s:"tile"===m?e.query.tileleft=s:e.query.mapleft=s:l.match(/.*?-right/i)&&("pixel"===m?e.query.pixelright=s:"tile"===m?e.query.tileright=s:e.query.mapright=s):e.query[r]=s;break;case"latitude":case"northing":l?l.match(/top-.*?/i)?"pixel"===m?e.query.pixeltop=s:"tile"===m?e.query.tiletop=s:e.query.maptop=s:l.match(/bottom-.*?/i)&&("pixel"===m?e.query.pixelbottom=s:"tile"===m?e.query.tilebottom=s:e.query.mapbottom=s):e.query[r]=s;break;case"i":"tile"===a?e.query.tilei=s:e.query.mapi=s;break;case"j":"tile"===a?e.query.tilej=s:e.query.mapj=s}else if("zoom"===n)e.query.zoom=s;else if(u){const c=o[i].htmlselect;e.query[s]=function(){return c.value}}else{const p=o[i];e.query[s]=function(){return p.getAttribute("value")}}}return e.query.title=t.title,e},reset:function(t,e){if(t&&this._map){var o=this._map&&this._map.hasLayer(this),i=this._templates;delete this._queries,this._map.off("click",null,this),this._templates=t;for(var n=0;n<t.length;n++)"tile"===t[n].rel?this._templates[n].layer=M.templatedTileLayer(t[n],L.Util.extend(this.options,{errorTileUrl:"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",zIndex:e,pane:this._container})):"image"===t[n].rel?this._templates[n].layer=M.templatedImageLayer(t[n],L.Util.extend(this.options,{zIndex:e,pane:this._container})):"features"===t[n].rel?this._templates[n].layer=M.templatedFeaturesLayer(t[n],L.Util.extend(this.options,{zIndex:e,pane:this._container})):"query"===t[n].rel&&(this._queries||(this._queries=[]),this._queries.push(L.extend(t[n],this._setupQueryVars(t[n])))),o&&this.onAdd(this._map);for(n=0;n<i.length;n++)this._map.hasLayer(i[n].layer)&&this._map.removeLayer(i[n].layer)}},onAdd:function(t){for(var e=0;e<this._templates.length;e++)"query"!==this._templates[e].rel&&t.addLayer(this._templates[e].layer)},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},onRemove:function(t){L.DomUtil.remove(this._container);for(var e=0;e<this._templates.length;e++)"query"!==this._templates[e].rel&&t.removeLayer(this._templates[e].layer)},_previousFeature:function(t){0<=this._count+-1&&(this._count--,this._map.fire("featurepagination",{i:this._count,popup:this}))},_nextFeature:function(t){this._count+1<this._source._totalFeatureCount&&(this._count++,this._map.fire("featurepagination",{i:this._count,popup:this}))},changeOpacity:function(t){this._container.style.opacity=t}}),y=L.Layer.extend({initialize:function(t,e){var o=M._extractInputBounds(t);this.zoomBounds=o.zoomBounds,this.extentBounds=o.bounds,this.isVisible=!0,this._template=t,this._extentEl=e.extentEl,this._container=L.DomUtil.create("div","leaflet-layer",e.pane),L.extend(e,this.zoomBounds),L.DomUtil.addClass(this._container,"mapml-features-container"),delete e.opacity,L.setOptions(this,L.extend(e,this._setUpFeaturesTemplateVars(t)))},getEvents:function(){return{moveend:this._onMoveEnd}},onAdd:function(){this._map._addZoomLimit(this);var t=this.options.opacity||1,e=this._container,o=this._map;this._features||(this._features=M.featureLayer(null,{renderer:M.featureRenderer(),pane:e,opacity:t,projection:o.options.projection,static:!0,onEachFeature:function(t,e){var o=document.createElement("div");o.classList.add("mapml-popup-content"),o.insertAdjacentHTML("afterbegin",t.innerHTML),e.bindPopup(o,{autoClose:!1,minWidth:108})}})),o.fire("moveend")},redraw:function(){this._onMoveEnd()},_removeCSS:function(){var o=this._container.querySelectorAll("link[rel=stylesheet],style");for(let e=0;e<o.length;e++){let t=o[e].parentNode;t.removeChild(o[e])}},_onMoveEnd:function(){var t=this._map.options.mapEl._history,e=t[t.length-1],o=t[t.length-2]??e,i=this._template.step,t=this._map.getZoom();let n=t;if("1"!==i&&(t+1)%i==0&&e.zoom===o.zoom-1||e.zoom===o.zoom||Math.floor(t/i)*i!=Math.floor(o.zoom/i)*i)n=Math.floor(t/i)*i;else if(t%this._template.step!=0)return;var a,r,s,l,m,u,c,p,o=this._map.getPixelBounds(this._map.getCenter(),n),i=this._getfeaturesUrl(n,o);i!==this._url&&(o=M.pixelToPCRSBounds(this._map.getPixelBounds(),t,this._map.options.projection),this.isVisible=t<=this.zoomBounds.maxZoom&&t>=this.zoomBounds.minZoom&&this.extentBounds.overlaps(o),this._features.clearLayers(),this._extentEl.shadowRoot&&(this._extentEl.shadowRoot.innerHTML=""),this._removeCSS(),this.isVisible||n!==t?(r=new Headers({Accept:"text/mapml;q=0.9,application/geo+json;q=0.8"}),s=new DOMParser,l=this._features,m=this._extentEl,u=this._map,p=function(i,n){return fetch(i,{redirect:"follow",headers:r}).then(function(t){return t.text()}).then(function(t){a=s.parseFromString(t,"application/xml");var e=new URL(a.querySelector("map-base")?a.querySelector("map-base").getAttribute("href"):i).href;i=(i=a.querySelector("map-link[rel=next]")?a.querySelector("map-link[rel=next]").getAttribute("href"):null)?new URL(i,e).href:null;var o,t=m._nativeZoom=a.querySelector("map-meta[name=zoom]")&&+M._metaContentToObject(a.querySelector("map-meta[name=zoom]").getAttribute("content")).value||0,e=m._nativeCS=a.querySelector("map-meta[name=cs]")&&M._metaContentToObject(a.querySelector("map-meta[name=cs]").getAttribute("content")).content||"PCRS";l.addData(a,e,t);for(o of a.querySelector("map-body").children)m.shadowRoot.append(o._DOMnode),o._DOMnode._extentEl=m;if(i&&--n)return p(i,n)})},(c=this)._url=i,p(i,10).then(function(){u.addLayer(l),u.fire("templatedfeatureslayeradd"),M.TemplatedFeaturesLayer.prototype._updateTabIndex(c)}).catch(function(t){console.log(t)})):this._url="")},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateTabIndex:function(t){var o,i=t||this;for(o in i._features._layers){let e=i._features._layers[o];if(e._path&&("M0 0"!==e._path.getAttribute("d")?e._path.setAttribute("tabindex",0):e._path.removeAttribute("tabindex"),0===e._path.childElementCount)){let t=document.createElement("title");t.innerText="Feature",e._path.appendChild(t)}}},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},onRemove:function(){this._map.removeLayer(this._features)},_getfeaturesUrl:function(t,e){void 0===t&&(t=this._map.getZoom()),void 0===e&&(e=this._map.getPixelBounds());var o,i={};for(o in this.options.feature.zoom&&(i[this.options.feature.zoom]=t),this.options.feature.width&&(i[this.options.feature.width]=this._map.getSize().x),this.options.feature.height&&(i[this.options.feature.height]=this._map.getSize().y),this.options.feature.bottom&&(i[this.options.feature.bottom]=this._TCRSToPCRS(e.max,t).y),this.options.feature.left&&(i[this.options.feature.left]=this._TCRSToPCRS(e.min,t).x),this.options.feature.top&&(i[this.options.feature.top]=this._TCRSToPCRS(e.min,t).y),this.options.feature.right&&(i[this.options.feature.right]=this._TCRSToPCRS(e.max,t).x),this.options.feature)["width","height","left","right","top","bottom","zoom"].indexOf(o)<0&&(i[o]=this.options.feature[o]);return L.Util.template(this._template.template,i)},_TCRSToPCRS:function(t,e){var o=this._map.options.crs;return o.transformation.untransform(t,o.scale(e))},_setUpFeaturesTemplateVars:function(t){var e={feature:{}},o=t.values;e.feature.hidden=[];for(var i=0;i<o.length;i++){var n=o[i].getAttribute("type"),a=o[i].getAttribute("units"),r=o[i].getAttribute("axis"),s=o[i].getAttribute("name"),l=o[i].getAttribute("position"),m=(o[i].getAttribute("value"),"map-select"===o[i].tagName.toLowerCase());if("width"===n)e.feature.width=s;else if("height"===n)e.feature.height=s;else if("zoom"===n)e.feature.zoom=s;else if("location"!==n||"pcrs"!==a&&"gcrs"!==a)if(m){const u=o[i].htmlselect;e.feature[s]=function(){return u.value}}else{const c=o[i];e.feature[s]=function(){return c.getAttribute("value")}}else switch(r){case"x":case"longitude":case"easting":l&&(l.match(/.*?-left/i)?e.feature.left=s:l.match(/.*?-right/i)&&(e.feature.right=s));break;case"y":case"latitude":case"northing":l&&(l.match(/top-.*?/i)?e.feature.top=s:l.match(/bottom-.*?/i)&&(e.feature.bottom=s))}}return e}}),f=L.Layer.extend({initialize:function(t,e){this._template=t,this._container=L.DomUtil.create("div","leaflet-layer",e.pane),L.DomUtil.addClass(this._container,"mapml-image-container");var o=M._extractInputBounds(t);this.zoomBounds=o.zoomBounds,this.extentBounds=o.bounds,this.isVisible=!0,delete e.opacity,L.extend(e,this.zoomBounds),L.setOptions(this,L.extend(e,this._setUpExtentTemplateVars(t)))},getEvents:function(){return{moveend:this._onMoveEnd,zoomstart:this._clearLayer}},onAdd:function(){this._map._addZoomLimit(this),this.setZIndex(this.options.zIndex),this._onAdd()},redraw:function(){this._onMoveEnd()},_clearLayer:function(){var e=this._container.querySelectorAll("img");for(let t=0;t<e.length;t++)this._container.removeChild(e[t])},_addImage:function(t,e,o){let i=this._map,n=this._imageLayer;t=this.getImageUrl(t,e),e=i.getSize();this._imageOverlay=M.imageLayer(t,o,e,0,this._container),this._imageOverlay._step=this._template.step,this._imageOverlay.addTo(i),n&&(this._imageOverlay._overlayToRemove=n._url,this._imageOverlay.on("load error",function(){i.removeLayer(n)}))},_scaleImage:function(o,i){let n=this;setTimeout(function(){var t=n._template.step,e=Math.floor(i/t)*t,t=n._map.getZoomScale(i,e),e=o.min.multiplyBy(t).subtract(n._map._getNewPixelOrigin(n._map.getCenter(),i)).round();L.DomUtil.setTransform(n._imageOverlay._image,e,t)})},_onAdd:function(){var t=this._map.getZoom();let e=t;var o=this._template.step;t%o!=0&&(e=Math.floor(t/o)*o);var i=this._map.getPixelBounds(this._map.getCenter(),e);this._pixelOrigins={},this._pixelOrigins[e]=i.min;o=this._map.getPixelBounds().min.subtract(this._map.getPixelOrigin());this._addImage(i,e,o),t!==e&&this._scaleImage(i,t)},_onMoveEnd:function(t){var e=this._map.getZoom(),o=this._map.options.mapEl._history,i=o[o.length-1];let n=o[o.length-2];n=n||i;var a,r=this._template.step,o=Math.floor(e/r)*r;let s=this._map.getPixelBounds(this._map.getCenter(),o);"1"!==r&&(e+1)%r==0&&i.zoom===n.zoom-1?(this._addImage(s,o,L.point(0,0)),this._scaleImage(s,e)):t&&e%r!=0?(this._imageOverlay._overlayToRemove=this._imageOverlay._url,i.zoom!==n.zoom?(this._addImage(s,o,L.point(0,0)),this._pixelOrigins[o]=s.min,this._scaleImage(s,e)):(a=this._pixelOrigins[o],a=s.min.subtract(a),this.getImageUrl(s,o)!==this._imageOverlay._url&&(this._addImage(s,o,a),this._scaleImage(s,e)))):(o=M.pixelToPCRSBounds(this._map.getPixelBounds(),e,this._map.options.projection),this.isVisible=e<=this.zoomBounds.maxZoom&&e>=this.zoomBounds.minZoom&&this.extentBounds.overlaps(o),this.isVisible?(o=(a=this._map).getPixelBounds().min.subtract(a.getPixelOrigin()),this._addImage(a.getPixelBounds(),e,o),this._pixelOrigins[e]=a.getPixelOrigin()):this._clearLayer())},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},onRemove:function(t){this._clearLayer(),t._removeZoomLimit(this),this._container=null},getImageUrl:function(t,e){var o,i={};for(o in i[this.options.extent.width]=this._map.getSize().x,i[this.options.extent.height]=this._map.getSize().y,i[this.options.extent.bottom]=this._TCRSToPCRS(t.max,e).y,i[this.options.extent.left]=this._TCRSToPCRS(t.min,e).x,i[this.options.extent.top]=this._TCRSToPCRS(t.min,e).y,i[this.options.extent.right]=this._TCRSToPCRS(t.max,e).x,this.options.extent)["width","height","left","right","top","bottom"].indexOf(o)<0&&(i[o]=this.options.extent[o]);return L.Util.template(this._template.template,i)},_TCRSToPCRS:function(t,e){var o=this._map.options.crs;return o.transformation.untransform(t,o.scale(e))},_setUpExtentTemplateVars:function(t){for(var e={extent:{}},o=t.values,i=0;i<t.values.length;i++){var n=o[i].getAttribute("type"),a=o[i].getAttribute("units"),r=o[i].getAttribute("axis"),s=o[i].getAttribute("name"),l=o[i].getAttribute("position"),m="map-select"===o[i].tagName.toLowerCase();if("width"===n)e.extent.width=s;else if("height"===n)e.extent.height=s;else if("location"!==n||"pcrs"!==a&&"gcrs"!==a)if(m){const u=o[i].htmlselect;e.extent[s]=function(){return u.value}}else{const c=o[i];e.extent[s]=function(){return c.getAttribute("value")}}else switch(r){case"longitude":case"easting":l&&(l.match(/.*?-left/i)?e.extent.left=s:l.match(/.*?-right/i)&&(e.extent.right=s));break;case"latitude":case"northing":l&&(l.match(/top-.*?/i)?e.extent.top=s:l.match(/bottom-.*?/i)&&(e.extent.bottom=s))}}return e}}),g=L.ImageOverlay.extend({initialize:function(t,e,o,i,n,a){this._container=n,this._url=t,this._location=e,this._size=L.point(o),this._angle=i,L.setOptions(this,a)},getEvents:function(){var t={viewreset:this._reset};return this._zoomAnimated&&this._step<=1&&(t.zoomanim=this._animateZoom),t},onAdd:function(){this.on({load:this._onImageLoad}),this._image||this._initImage(),this.options.interactive&&(L.DomUtil.addClass(this._image,"leaflet-interactive"),this.addInteractiveTarget(this._image)),this._container.appendChild(this._image),this._reset()},onRemove:function(){L.DomUtil.remove(this._image),this.options.interactive&&this.removeInteractiveTarget(this._image)},_onImageLoad:function(){this._image&&(this._image.loaded=+new Date,this._updateOpacity())},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),t=this._map.getPixelOrigin().add(this._location).multiplyBy(e).subtract(this._map._getNewPixelOrigin(t.center,t.zoom)).round();L.Browser.any3d?L.DomUtil.setTransform(this._image,t,e):L.DomUtil.setPosition(this._image,t)},_reset:function(t){var e=this._image,o=this._location,i=this._size;t&&1<this._step&&(void 0===this._overlayToRemove||this._url===this._overlayToRemove)||(L.DomUtil.setPosition(e,o),e.style.width=i.x+"px",e.style.height=i.y+"px")},_updateOpacity:function(){var t,e,o;this._map&&(o=+new Date,t=!1,e=this._image,o=Math.min(1,(o-e.loaded)/200),L.DomUtil.setOpacity(e,o),(t=o<1?!0:t)&&(L.Util.cancelAnimFrame(this._fadeFrame),this._fadeFrame=L.Util.requestAnimFrame(this._updateOpacity,this)),L.DomUtil.addClass(e,"leaflet-image-loaded"))}}),x=L.Layer.extend({options:{maxNext:10,zIndex:0,maxZoom:25,opacity:"1.0"},initialize:function(t,e,o){var i;t&&(this._href=t),e&&(i=!!(this._layerEl=e).querySelector("map-feature,map-tile,map-extent"),!t&&i&&(this._content=e)),L.setOptions(this,o),this._container=L.DomUtil.create("div","leaflet-layer"),this.changeOpacity(this.options.opacity),L.DomUtil.addClass(this._container,"mapml-layer"),this._imageContainer=L.DomUtil.create("div","leaflet-layer",this._container),L.DomUtil.addClass(this._imageContainer,"mapml-image-container"),this._mapmlTileContainer=L.DomUtil.create("div","mapml-tile-container",this._container),!i&&e&&e.hasAttribute("label")&&(this._title=e.getAttribute("label")),this._initialize(i?e:null),this.on("attached",this._validateExtent,this),this.validProjection=!0,this._mapmlLayerItem={}},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},getHref:function(){return this._href??""},_updateZIndex:function(){this._container&&void 0!==this.options.zIndex&&null!==this.options.zIndex&&(this._container.style.zIndex=this.options.zIndex)},_removeExtents:function(e){if(this._extent._mapExtents)for(let t=0;t<this._extent._mapExtents.length;t++)this._extent._mapExtents[t].templatedLayer&&e.removeLayer(this._extent._mapExtents[t].templatedLayer);this._extent._queries&&delete this._extent._queries},_changeOpacity:function(t){t&&t.target&&0<=t.target.value&&t.target.value<=1&&this.changeOpacity(t.target.value)},changeOpacity:function(t){this._container.style.opacity=t,this.opacityEl&&(this.opacityEl.value=t)},_changeExtentOpacity:function(t){t&&t.target&&0<=t.target.value&&t.target.value<=1&&(this.templatedLayer.changeOpacity(t.target.value),this._templateVars.opacity=t.target.value)},_changeExtent:function(t,e){t.target.checked?(e.checked=!0,this._layerEl.checked&&(e.templatedLayer=M.templatedLayer(e._templateVars,{pane:this._container,opacity:e._templateVars.opacity,_leafletLayer:this,crs:e.crs,extentZIndex:e.extentZIndex,extentEl:e._DOMnode||e}).addTo(this._map),e.templatedLayer.setZIndex(),this._setLayerElExtent())):(L.DomEvent.stopPropagation(t),e.checked=!1,this._layerEl.checked&&this._map.removeLayer(e.templatedLayer),this._setLayerElExtent())},onAdd:function(o){if(!this._extent||this._validProjection(o)){this._map=o,this._content?(this._mapmlvectors||(this._mapmlvectors=M.featureLayer(this._content,{renderer:M.featureRenderer(),pane:this._container,opacity:this.options.opacity,projection:o.options.projection,_leafletLayer:this,static:!0,onEachFeature:function(t,e){var o;t&&((o=document.createElement("div")).classList.add("mapml-popup-content"),o.insertAdjacentHTML("afterbegin",t.innerHTML),e.bindPopup(o,{autoClose:!1,minWidth:165}))}})),this._setLayerElExtent(),o.addLayer(this._mapmlvectors)):this.once("extentload",function(){this._validProjection(o)?(this._mapmlvectors||(this._mapmlvectors=M.featureLayer(this._content,{renderer:M.featureRenderer(),pane:this._container,opacity:this.options.opacity,projection:o.options.projection,_leafletLayer:this,static:!0,onEachFeature:function(t,e){var o;t&&((o=document.createElement("div")).classList.add("mapml-popup-content"),o.insertAdjacentHTML("afterbegin",t.innerHTML),e.bindPopup(o,{autoClose:!1,minWidth:165}))}}).addTo(o)),this._setLayerElExtent()):this.validProjection=!1},this),this._imageLayer||(this._imageLayer=L.layerGroup()),o.addLayer(this._imageLayer),(!this._staticTileLayer||null===this._staticTileLayer._container)&&0<this._mapmlTileContainer.getElementsByTagName("map-tiles").length&&(this._staticTileLayer=M.staticTileLayer({pane:this._container,_leafletLayer:this,className:"mapml-static-tile-layer",tileContainer:this._mapmlTileContainer,maxZoomBound:o.options.crs.options.resolutions.length-1,tileSize:o.options.crs.options.crs.tile.bounds.max.x}),o.addLayer(this._staticTileLayer),this._setLayerElExtent());const t=function(){if(this._extent&&this._extent._mapExtents){for(let t=0;t<this._extent._mapExtents.length;t++){var e;this._extent._mapExtents[t]._templateVars&&this._extent._mapExtents[t].checked&&(this._extent._mapExtents[t].extentZIndex||(this._extent._mapExtents[t].extentZIndex=t),this._templatedLayer=M.templatedLayer(this._extent._mapExtents[t]._templateVars,{pane:this._container,opacity:this._extent._mapExtents[t]._templateVars.opacity,_leafletLayer:this,crs:this._extent.crs,extentZIndex:this._extent._mapExtents[t].extentZIndex,extentEl:this._extent._mapExtents[t]._DOMnode||this._extent._mapExtents[t]}).addTo(o),this._extent._mapExtents[t].templatedLayer=this._templatedLayer,this._templatedLayer._queries&&(this._extent._queries||(this._extent._queries=[]),this._extent._queries=this._extent._queries.concat(this._templatedLayer._queries))),this._extent._mapExtents[t].hasAttribute("opacity")&&(e=this._extent._mapExtents[t].getAttribute("opacity"),this._extent._mapExtents[t].templatedLayer.changeOpacity(e))}this._setLayerElExtent()}}.bind(this);this._extent&&this._extent._mapExtents&&this._extent._mapExtents[0]._templateVars?t():this.once("extentload",function(){this._validProjection(o)?t():this.validProjection=!1},this),this.setZIndex(this.options.zIndex),this.getPane().appendChild(this._container),setTimeout(()=>{o.fire("checkdisabled")},0),o.on("popupopen",this._attachSkipButtons,this)}else this.validProjection=!1},_validProjection:function(e){let o=!1;if(this._extent&&this._extent._mapExtents)for(let t=0;t<this._extent._mapExtents.length;t++)if(this._extent._mapExtents[t]._templateVars)for(var i of this._extent._mapExtents[t]._templateVars)if(!i.projectionMatch&&i.projection!==e.options.projection){o=!0;break}return!(o||this.getProjection()!==e.options.projection.toUpperCase())},_setLayerElExtent:function(){let i,n,a,r,s,e={minZoom:0,maxZoom:0,maxNativeZoom:0,minNativeZoom:0};["_staticTileLayer","_imageLayer","_mapmlvectors","_templatedLayer"].forEach(t=>{if(this[t])if("_templatedLayer"===t){for(let e=0;e<this._extent._mapExtents.length;e++)for(let t=0;t<this._extent._mapExtents[e]._templateVars.length;t++){var o=M._extractInputBounds(this._extent._mapExtents[e]._templateVars[t]);this._extent._mapExtents[e]._templateVars[t].tempExtentBounds=o.bounds,this._extent._mapExtents[e]._templateVars[t].extentZoomBounds=o.zoomBounds}for(let e=0;e<this._extent._mapExtents.length;e++)if(this._extent._mapExtents[e].checked)for(let t=0;t<this._extent._mapExtents[e]._templateVars.length;t++)s=i?(i.extend(this._extent._mapExtents[e]._templateVars[t].tempExtentBounds.min),i.extend(this._extent._mapExtents[e]._templateVars[t].tempExtentBounds.max),n=Math.max(n,this._extent._mapExtents[e]._templateVars[t].extentZoomBounds.maxZoom),a=Math.min(a,this._extent._mapExtents[e]._templateVars[t].extentZoomBounds.minZoom),r=Math.max(r,this._extent._mapExtents[e]._templateVars[t].extentZoomBounds.maxNativeZoom),Math.min(s,this._extent._mapExtents[e]._templateVars[t].extentZoomBounds.minNativeZoom)):(i=this._extent._mapExtents[e]._templateVars[t].tempExtentBounds,n=this._extent._mapExtents[e]._templateVars[t].extentZoomBounds.maxZoom,a=this._extent._mapExtents[e]._templateVars[t].extentZoomBounds.minZoom,r=this._extent._mapExtents[e]._templateVars[t].extentZoomBounds.maxNativeZoom,this._extent._mapExtents[e]._templateVars[t].extentZoomBounds.minNativeZoom);e.minZoom=a,e.maxZoom=n,e.minNativeZoom=s,e.maxNativeZoom=r,this._extent.zoomBounds=e,this._extent.layerBounds=i;for(let t=0;t<this._extent._mapExtents.length;t++)this._extent._mapExtents[t].templatedLayer.layerBounds=i,this._extent._mapExtents[t].templatedLayer.zoomBounds=e}else this[t].layerBounds&&(i?(i.extend(this[t].layerBounds.min),i.extend(this[t].layerBounds.max)):(i=this[t].layerBounds,e=this[t].zoomBounds))}),i&&(this._layerEl.extent=Object.assign(M._convertAndFormatPCRS(i,this._map),{zoom:e}))},addTo:function(t){return t.addLayer(this),this},getEvents:function(){return{zoomanim:this._onZoomAnim}},redraw:function(){if(this._extent._mapExtents)for(let t=0;t<this._extent._mapExtents.length;t++)this._extent._mapExtents[t].templatedLayer&&this._extent._mapExtents[t].templatedLayer.redraw()},_onZoomAnim:function(t){if(this._map){var t=t.zoom,e=this._extent&&this._extent._mapExtents?this._extent._mapExtents[0].querySelector("map-input[type=zoom]"):null,o=e&&e.hasAttribute("min")?parseInt(e.getAttribute("min")):this._map.getMinZoom(),i=e&&e.hasAttribute("max")?parseInt(e.getAttribute("max")):this._map.getMaxZoom();if(e)for(let t=1;t<this._extent._mapExtents.length;t++)(e=this._extent._mapExtents[t].querySelector("map-input[type=zoom]"))&&e.hasAttribute("min")&&(o=Math.min(parseInt(e.getAttribute("min")),o)),e&&e.hasAttribute("max")&&(i=Math.max(parseInt(e.getAttribute("max")),i));t<o&&this._extent.zoomout||i<t&&this._extent.zoomin;o<=t&&t<=i||(this._extent.zoomin&&i<t?(this._href=this._extent.zoomin,this._layerEl.src=this._extent.zoomin,this.href=this._extent.zoomin,this._layerEl.src=this._extent.zoomin):this._extent.zoomout&&t<o&&(this._href=this._extent.zoomout,this.href=this._extent.zoomout,this._layerEl.src=this._extent.zoomout)),this._templatedLayer}},onRemove:function(t){L.DomUtil.remove(this._container),this._staticTileLayer&&t.removeLayer(this._staticTileLayer),this._mapmlvectors&&t.removeLayer(this._mapmlvectors),this._imageLayer&&t.removeLayer(this._imageLayer),this._extent&&this._extent._mapExtents&&this._removeExtents(t),t.fire("checkdisabled"),t.off("popupopen",this._attachSkipButtons)},getAttribution:function(){return this.options.attribution},getLayerExtentHTML:function(t,o){var i=L.DomUtil.create("fieldset","mapml-layer-extent"),e=L.DomUtil.create("div","mapml-layer-item-properties",i),n=L.DomUtil.create("div","mapml-layer-item-settings",i),a=L.DomUtil.create("label","mapml-layer-item-toggle",e),r=L.DomUtil.create("input"),s=L.SVG.create("svg"),l=L.SVG.create("path"),m=L.SVG.create("path"),u=L.DomUtil.create("span"),c=L.DomUtil.create("div","mapml-layer-item-controls",e),p=L.DomUtil.create("details","mapml-layer-item-opacity",n),e=L.DomUtil.create("summary","",p),h=this._layerEl.parentNode,d=this._layerEl,p=L.DomUtil.create("input","",p);n.hidden=!0,i.setAttribute("aria-grabbed","false"),t||(i.setAttribute("hidden",""),this._extent._mapExtents[o].hidden=!0),s.setAttribute("viewBox","0 0 24 24"),s.setAttribute("height","22"),s.setAttribute("width","22"),l.setAttribute("d","M0 0h24v24H0z"),l.setAttribute("fill","none"),m.setAttribute("d","M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"),s.appendChild(l),s.appendChild(m);let _=L.DomUtil.create("button","mapml-layer-item-remove-control",c);_.type="button",_.title="Remove Sub Layer",_.innerHTML="<span aria-hidden='true'>&#10005;</span>",_.classList.add("mapml-button"),L.DomEvent.on(_,"click",L.DomEvent.stop),L.DomEvent.on(_,"click",t=>{let e=!0;t.target.checked=!1,this._extent._mapExtents[o].removed=!0,this._extent._mapExtents[o].checked=!1,this._layerEl.checked&&this._changeExtent(t,this._extent._mapExtents[o]),this._extent._mapExtents[o].extentAnatomy.parentNode.removeChild(this._extent._mapExtents[o].extentAnatomy);for(let t=0;t<this._extent._mapExtents.length;t++)this._extent._mapExtents[t].removed||(e=!1);e&&this._layerItemSettingsHTML.removeChild(this._extentGroupAnatomy)},this);let y=L.DomUtil.create("button","mapml-layer-item-settings-control",c);y.type="button",y.title="Extent Settings",y.setAttribute("aria-expanded",!1),y.classList.add("mapml-button"),L.DomEvent.on(y,"click",t=>{!0===n.hidden?(y.setAttribute("aria-expanded",!0),n.hidden=!1):(y.setAttribute("aria-expanded",!1),n.hidden=!0)},this),u.setAttribute("aria-hidden",!0),a.appendChild(r),y.appendChild(u),u.appendChild(s),e.innerText="Opacity",e.id="mapml-layer-item-opacity-"+L.stamp(e),p.setAttribute("type","range"),p.setAttribute("min","0"),p.setAttribute("max","1.0"),p.setAttribute("step","0.1"),p.setAttribute("aria-labelledby","mapml-layer-item-opacity-"+L.stamp(e));e=this._extent._mapExtents[o].hasAttribute("opacity")?this._extent._mapExtents[o].getAttribute("opacity"):"1.0";this._extent._mapExtents[o]._templateVars.opacity=e,p.setAttribute("value",e),p.value=e,L.DomEvent.on(p,"change",this._changeExtentOpacity,this._extent._mapExtents[o]);a=L.DomUtil.create("span","mapml-layer-item-name",a);return r.defaultChecked=!!this._extent._mapExtents[o],this._extent._mapExtents[o].checked=r.defaultChecked,r.type="checkbox",a.innerHTML=t,L.DomEvent.on(r,"change",t=>{this._changeExtent(t,this._extent._mapExtents[o])}),a.id="mapml-extent-item-name-{"+L.stamp(a)+"}",i.setAttribute("aria-labelledby",a.id),a.extent=this._extent._mapExtents[o],i.ontouchstart=i.onmousedown=e=>{if("label"===e.target.parentElement.tagName.toLowerCase()&&"input"!==e.target.tagName.toLowerCase()||"label"===e.target.tagName.toLowerCase()){e.stopPropagation(),e=e instanceof TouchEvent?e.touches[0]:e;let s=i,l=i.parentNode,t=!1,m=e.clientY;document.body.ontouchmove=document.body.onmousemove=a=>{a.preventDefault();var r=(a=a instanceof TouchEvent?a.touches[0]:a).clientY-m;if(t=5<Math.abs(r)||t,!(l&&!t||l&&l.childElementCount<=1||l.getBoundingClientRect().top>s.getBoundingClientRect().bottom||l.getBoundingClientRect().bottom<s.getBoundingClientRect().top)){l.classList.add("mapml-draggable"),s.style.transform="translateY("+r+"px)",s.style.pointerEvents="none";let t=a.clientX,e=a.clientY,o=("MAPML-VIEWER"===h.tagName?h:h.querySelector(".mapml-web-map")).shadowRoot,i=o.elementFromPoint(t,e),n=i&&i.closest("fieldset")?i.closest("fieldset"):s;n=Math.abs(r)<=n.offsetHeight?s:n,s.setAttribute("aria-grabbed","true"),s.setAttribute("aria-dropeffect","move"),n&&l===n.parentNode&&(n=n!==s.nextSibling?n:n.nextSibling,s!==n&&(m=a.clientY,s.style.transform=null),l.insertBefore(s,n))}},document.body.ontouchend=document.body.onmouseup=()=>{s.setAttribute("aria-grabbed","false"),s.removeAttribute("aria-dropeffect"),s.style.pointerEvents=null,s.style.transform=null;let t=l.children,e=0;for(var o of t){let t=o.querySelector("span").extent;t.setAttribute("data-moving",""),d.insertAdjacentElement("beforeend",t),t.removeAttribute("data-moving"),t.extentZIndex=e,t.templatedLayer.setZIndex(e),e++}l.classList.remove("mapml-draggable"),document.body.ontouchmove=document.body.onmousemove=document.body.ontouchend=document.body.onmouseup=null}}},i},getLayerUserControlsHTML:function(){var o=L.DomUtil.create("fieldset","mapml-layer-item"),t=L.DomUtil.create("input"),e=L.DomUtil.create("span","mapml-layer-item-name"),i=L.DomUtil.create("span"),n=L.DomUtil.create("div","mapml-layer-item-properties",o),a=L.DomUtil.create("div","mapml-layer-item-settings",o),r=L.DomUtil.create("label","mapml-layer-item-toggle",n),s=L.DomUtil.create("div","mapml-layer-item-controls",n),l=L.DomUtil.create("details","mapml-layer-item-opacity mapml-control-layers",a),m=L.DomUtil.create("input"),u=L.DomUtil.create("summary"),c=L.SVG.create("svg"),p=L.SVG.create("path"),n=L.SVG.create("path"),h=L.DomUtil.create("fieldset","mapml-layer-grouped-extents"),d=this._layerEl.parentNode;this.opacityEl=m,this._mapmlLayerItem=o,c.setAttribute("viewBox","0 0 24 24"),c.setAttribute("height","22"),c.setAttribute("width","22"),c.setAttribute("fill","currentColor"),p.setAttribute("d","M0 0h24v24H0z"),p.setAttribute("fill","none"),n.setAttribute("d","M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"),c.appendChild(p),c.appendChild(n),a.hidden=!0,i.setAttribute("aria-hidden",!0);let _=L.DomUtil.create("button","mapml-layer-item-remove-control",s);_.type="button",_.title="Remove Layer",_.innerHTML="<span aria-hidden='true'>&#10005;</span>",_.classList.add("mapml-button"),L.DomEvent.on(_,"click",L.DomEvent.stop),L.DomEvent.on(_,"click",t=>{let e=0,o,i;if(i=("MAPML-VIEWER"===d.tagName?d:d.querySelector(".mapml-web-map")).shadowRoot,t.target.closest("fieldset").nextElementSibling&&!t.target.closest("fieldset").nextElementSibling.disbaled)for(o=t.target.closest("fieldset").previousElementSibling;o;)e+=2,o=o.previousElementSibling;else o="link";d.removeChild(t.target.closest("fieldset").querySelector("span").layer._layerEl),o=o?i.querySelector(".leaflet-control-attribution").firstElementChild:o=i.querySelectorAll("input")[e],o.focus()},this);let y=L.DomUtil.create("button","mapml-layer-item-settings-control",s);if(y.type="button",y.title="Layer Settings",y.setAttribute("aria-expanded",!1),y.classList.add("mapml-button"),L.DomEvent.on(y,"click",t=>{let e=this._layerEl._layerControl._container;e._isExpanded||"touch"!==t.pointerType?!0===a.hidden?(y.setAttribute("aria-expanded",!0),a.hidden=!1):(y.setAttribute("aria-expanded",!1),a.hidden=!0):e._isExpanded=!0},this),t.defaultChecked=!!this._map,t.type="checkbox",t.setAttribute("class","leaflet-control-layers-selector"),(e.layer=this)._legendUrl?((s=document.createElement("a")).text=" "+this._title,s.href=this._legendUrl,s.target="_blank",s.draggable=!1,e.appendChild(s)):e.innerHTML=this._title,e.id="mapml-layer-item-name-{"+L.stamp(e)+"}",u.innerText="Opacity",u.id="mapml-layer-item-opacity-"+L.stamp(u),l.appendChild(u),l.appendChild(m),m.setAttribute("type","range"),m.setAttribute("min","0"),m.setAttribute("max","1.0"),m.setAttribute("value",this._container.style.opacity||"1.0"),m.setAttribute("step","0.1"),m.setAttribute("aria-labelledby",u.id),m.value=this._container.style.opacity||"1.0",o.setAttribute("aria-grabbed","false"),o.setAttribute("aria-labelledby",e.id),o.ontouchstart=o.onmousedown=e=>{if("label"===e.target.parentElement.tagName.toLowerCase()&&"input"!==e.target.tagName.toLowerCase()||"label"===e.target.tagName.toLowerCase()){e=e instanceof TouchEvent?e.touches[0]:e;let s=o,l=o.parentNode,t=!1,m=e.clientY;document.body.ontouchmove=document.body.onmousemove=a=>{a.preventDefault();var r=(a=a instanceof TouchEvent?a.touches[0]:a).clientY-m;if(t=5<Math.abs(r)||t,!(l&&!t||l&&l.childElementCount<=1||l.getBoundingClientRect().top>s.getBoundingClientRect().bottom||l.getBoundingClientRect().bottom<s.getBoundingClientRect().top)){l.classList.add("mapml-draggable"),s.style.transform="translateY("+r+"px)",s.style.pointerEvents="none";let t=a.clientX,e=a.clientY,o=("MAPML-VIEWER"===d.tagName?d:d.querySelector(".mapml-web-map")).shadowRoot,i=o.elementFromPoint(t,e),n=i&&i.closest("fieldset")?i.closest("fieldset"):s;n=Math.abs(r)<=n.offsetHeight?s:n,s.setAttribute("aria-grabbed","true"),s.setAttribute("aria-dropeffect","move"),n&&l===n.parentNode&&(n=n!==s.nextSibling?n:n.nextSibling,s!==n&&(m=a.clientY,s.style.transform=null),l.insertBefore(s,n))}},document.body.ontouchend=document.body.onmouseup=()=>{s.setAttribute("aria-grabbed","false"),s.removeAttribute("aria-dropeffect"),s.style.pointerEvents=null,s.style.transform=null;let t=l.children,e=1;for(var o of t){let t=o.querySelector("span").layer._layerEl;t.setAttribute("data-moving",""),d.insertAdjacentElement("beforeend",t),t.removeAttribute("data-moving"),t._layer.setZIndex(e),e++}l.classList.remove("mapml-draggable"),document.body.ontouchmove=document.body.onmousemove=document.body.onmouseup=null}}},L.DomEvent.on(m,"change",this._changeOpacity,this),r.appendChild(t),r.appendChild(e),y.appendChild(i),i.appendChild(c),this._styles&&a.appendChild(this._styles),this._userInputs){var f=document.createDocumentFragment(),g=this._extent._templateVars;if(g)for(var x=0;x<g.length;x++)for(var b=g[x],v=0;v<b.values.length;v++){var M,E,C=b.values[v],A="#"+C.getAttribute("id");"map-select"!==C.tagName.toLowerCase()||f.querySelector(A)||(M=L.DomUtil.create("details","mapml-layer-item-time mapml-control-layers",f),E=L.DomUtil.create("summary"),(A=L.DomUtil.create("label")).innerText=C.getAttribute("name"),A.setAttribute("for",C.getAttribute("id")),E.appendChild(A),M.appendChild(E),M.appendChild(C.htmlselect))}a.appendChild(f)}if(this._extent&&this._extent._mapExtents){var T=!0;this._layerItemSettingsHTML=a,(this._extentGroupAnatomy=h).setAttribute("aria-label","Sublayers");for(let t=0;t<this._extent._mapExtents.length;t++)h.appendChild(this._extent._mapExtents[t].extentAnatomy),this._extent._mapExtents[t].hidden||(T=!1);T||a.appendChild(h)}return this._mapmlLayerItem},_initialize:function(t){var S,E,e,o;function C(e,i,n,t,o,a){var r=[],s=e.querySelectorAll("map-link[rel=tile],map-link[rel=image],map-link[rel=features],map-link[rel=query]"),l=new RegExp("(?:{)(.*?)(?:})","g"),m=e.querySelector('map-input[type="zoom" i]'),u=!1,c={zoom:0};if(i){let t=M._metaContentToObject(i.getAttribute("content")),e;c.zoom=t.zoom||c.zoom;let o=Object.keys(t);for(let t=0;t<o.length;t++)if(!o[t].includes("zoom")){e=M.axisToCS(o[t].split("-")[2]);break}i=M.csToAxes(e);c.bounds=M.boundsToPCRSBounds(L.bounds(L.point(+t["top-left-"+i[0]],+t["top-left-"+i[1]]),L.point(+t["bottom-right-"+i[0]],+t["bottom-right-"+i[1]])),c.zoom,n,e)}else c.bounds=M[n].options.crs.pcrs.bounds;for(var p=0;p<s.length;p++){var h=s[p],d=h.getAttribute("tref");if(h.zoomInput=m,!d){var _,d=k;for(_ of t.querySelectorAll("map-input"))d+=`{${_.getAttribute("name")}}`}for(var y=h.hasAttribute("title")?h.getAttribute("title"):"Query this layer",f=d.match(l),g=h.hasAttribute("rel")&&"tile"!==h.getAttribute("rel").toLowerCase()?h.getAttribute("rel").toLowerCase():"tile",x=h.hasAttribute("type")?h.getAttribute("type").toLowerCase():"image/*",b=[],v=h&&h.hasAttribute("tms"),E=t.querySelector("map-meta[name=zoom]")?M._metaContentToObject(t.querySelector("map-meta[name=zoom]").getAttribute("content")):void 0;null!==(T=l.exec(d));){var C,A=T[1],T=e.querySelector("map-input[name="+A+"],map-select[name="+A+"]");if(!T){console.log("input with name="+A+" not found for template variable of same name");break}!T.hasAttribute("type")||"location"!==T.getAttribute("type")||T.hasAttribute("min")&&T.hasAttribute("max")||!T.hasAttribute("axis")||["i","j"].includes(T.getAttribute("axis").toLowerCase())||(m&&d.includes(`{${m.getAttribute("name")}}`)&&m.setAttribute("value",c.zoom),C=T.getAttribute("axis"),A=M.convertPCRSBounds(c.bounds,c.zoom,n,M.axisToCS(C)),T.setAttribute("min",A.min[M.axisToXY(C)]),T.setAttribute("max",A.max[M.axisToXY(C)])),b.push(T),u=u||T.hasAttribute("type")&&"zoom"===T.getAttribute("type").toLowerCase(),"map-select"===T.tagName.toLowerCase()&&((C=document.createElement("div")).insertAdjacentHTML("afterbegin",T.outerHTML),T.htmlselect=C.querySelector("map-select"),T.htmlselect=function(e){var o=document.createElement("select"),i=e.getAttributeNames();for(let t=0;t<i.length;t++)o.setAttribute(i[t],e.getAttribute(i[t]));var n=e.children;for(let e=0;e<n.length;e++){var a=document.createElement("option"),r=n[e].getAttributeNames();for(let t=0;t<r.length;t++)a.setAttribute(r[t],n[e].getAttribute(r[t]));a.innerHTML=n[e].innerHTML,o.appendChild(a)}return o}(T.htmlselect),L.DomEvent.on(T.htmlselect,"change",S.redraw,S),S._userInputs||(S._userInputs=[]),S._userInputs.push(T.htmlselect))}if(d&&f.length===b.length||d===k){"query"===g&&(S.queryable=!0),!u&&m&&b.push(m);let t=m?m.getAttribute("step"):1;t&&"0"!==t&&!isNaN(t)||(t=1),r.push({template:decodeURI(new URL(d,o)),linkEl:h,title:y,rel:g,type:x,values:b,zoomBounds:E,extentPCRSFallback:{bounds:c.bounds},projectionMatch:a,projection:e.getAttribute("units")||I,tms:v,step:t})}}return r}function i(t){var e=this.responseXML||t;if(e.querySelector&&e.querySelector("map-feature")&&(S._content=e),!this.responseXML&&this.responseText&&(e=(new DOMParser).parseFromString(this.responseText,"text/xml")),this.readyState===this.DONE&&e.querySelector&&!e.querySelector("parsererror")){var o,i=e.querySelectorAll("map-extent");if(i.length||(m=e.querySelector("map-meta[name=projection]")),1<=i.length)for(let t=0;t<i.length&&(n=(o="map-extent"===i[t].tagName.toLowerCase()&&i[t].hasAttribute("units")?i[t].getAttribute("units"):o)&&o===S.options.mapprojection);t++);else m&&"map-meta"===m.tagName.toLowerCase()&&m.hasAttribute("content")&&(n=(o=M._metaContentToObject(m.getAttribute("content")).content)&&o===S.options.mapprojection);var n,a,r=e.querySelector("map-meta[name=extent]"),s=!n&&e.querySelector("map-head map-link[rel=alternate][projection="+S.options.mapprojection+"]"),l=new URL(e.querySelector("map-base")?e.querySelector("map-base").getAttribute("href"):e.baseURI||this.responseURL,this.responseURL).href;if(!n&&s&&s.hasAttribute("href"))return void S.fire("changeprojection",{href:new URL(s.getAttribute("href"),l).href},!1);if(!n&&S._map&&1===S._map.options.mapEl.querySelectorAll("layer-").length)return void(S._map.options.mapEl.projection=o);if(m)S._extent=m;else{S._extent={},n&&(S._extent.crs=M[o]),S._extent._mapExtents=[],S._extent._templateVars=[];for(let t=0;t<i.length;t++)i[t].querySelector("map-link[rel=tile],map-link[rel=image],map-link[rel=features],map-link[rel=query]")&&i[t].hasAttribute("units")&&(S._extent._mapExtents.push(i[t]),n=n||s,a=C.call(S,i[t],r,o,e,l,n),S._extent._mapExtents[t]._templateVars=a,S._extent._templateVars=S._extent._templateVars.concat(a))}S._parseLicenseAndLegend(e,S,o);var t=e.querySelector("map-link[rel=zoomin]"),m=e.querySelector("map-link[rel=zoomout]");if(delete S._extent.zoomin,delete S._extent.zoomout,t&&(S._extent.zoomin=new URL(t.getAttribute("href"),l).href),m&&(S._extent.zoomout=new URL(m.getAttribute("href"),l).href),S._extent._mapExtents)for(let t=0;t<S._extent._mapExtents.length;t++)S._extent._mapExtents[t].templatedLayer&&S._extent._mapExtents[t].templatedLayer.reset(S._extent._mapExtents[t]._templateVars,S._extent._mapExtents[t].extentZIndex);if(e.querySelector("map-tile")){var u=document.createElement("map-tiles"),c=e.querySelector("map-meta[name=zoom][content]")||e.querySelector("map-input[type=zoom][value]");u.setAttribute("zoom",c&&c.getAttribute("content")||c&&c.getAttribute("value")||"0");for(var p=e.getElementsByTagName("map-tile"),h=0;h<p.length;h++)u.appendChild(document.importNode(p[h],!0));S._mapmlTileContainer.appendChild(u)}if(M._parseStylesheetAsHTML(e,l,S._container),S._extent._mapExtents)for(let t=0;t<S._extent._mapExtents.length;t++){var d=S._extent._mapExtents[t].getAttribute("label"),d=S.getLayerExtentHTML(d,t);S._extent._mapExtents[t].extentAnatomy=d}var _=e.querySelectorAll('map-link[rel=style],map-link[rel="self style"],map-link[rel="style self"]');if(1<_.length){var y=document.createElement("details"),c=document.createElement("summary");c.innerText="Style",y.appendChild(c);for(var f=function(t){S.fire("changestyle",{src:t.target.getAttribute("data-href")},!1)},g=0;g<_.length;g++){var x=document.createElement("div"),b=x.appendChild(document.createElement("input"));b.setAttribute("type","radio"),b.setAttribute("id","rad-"+L.stamp(b)),b.setAttribute("name","styles-"+this._title),b.setAttribute("value",_[g].getAttribute("title")),b.setAttribute("data-href",new URL(_[g].getAttribute("href"),l).href);var v=x.appendChild(document.createElement("label"));v.setAttribute("for","rad-"+L.stamp(b)),v.innerText=_[g].getAttribute("title"),"style self"!==_[g].getAttribute("rel")&&"self style"!==_[g].getAttribute("rel")||(b.checked=!0),y.appendChild(x),L.DomUtil.addClass(y,"mapml-layer-item-style mapml-control-layers"),L.DomEvent.on(b,"click",f,S)}S._styles=y}e.querySelector("map-title")?S._title=e.querySelector("map-title").textContent.trim():e instanceof Element&&e.hasAttribute("label")&&(S._title=e.getAttribute("label").trim()),S._map&&(S._validateExtent(),S._map.hasLayer(S)&&S._map.attributionControl.addAttribution(S.getAttribution()))}else S.error=!0;this.responseXML&&!function(){let t=E.responseXML,o=this._layerEl.shadowRoot;if(t){var e=t.children[0].children[1].children;if(e){var i,n,a=t.children[0].children[0].querySelector("map-base")?.getAttribute("href");for(i of e){let e=i.cloneNode(!0);if(i._DOMnode=e,"map-link"===e.nodeName){let t=e.getAttribute("href")||e.getAttribute("tref");!t||0!==t.indexOf("http://")&&0!==t.indexOf("https://")||(n=a+t,e.hasAttribute("href")?e.setAttribute("href",n):e.setAttribute("tref",n))}o.appendChild(e)}}}}.call(S),S.fire("extentload",S,!1),S._layerEl.parentElement&&S._layerEl.parentElement._toggleControls(),S._layerEl.dispatchEvent(new CustomEvent("extentload",{detail:S}))}(this._href||t)&&((S=this)._href?(E=new XMLHttpRequest,e=this._href,o=i,E.onreadystatechange=function(){this.readyState===this.DONE&&(400!==this.status&&404!==this.status&&500!==this.status&&406!==this.status||(S.error=!0,S.fire("extentload",S,!0),E.abort()))},E.onload=o,E.onerror=function(){S.error=!0,S.fire("extentload",S,!0)},E.open("GET",e),E.setRequestHeader("Accept",M.mime),E.overrideMimeType("text/xml"),E.send()):t&&i.call(this,t))},_validateExtent:function(){if(this._extent&&this._map){var e,o=this._extent._mapExtents||[this._extent];for(let t=0;t<o.length;t++){if(!o[t].querySelector)return;o[t].querySelector('[type=zoom][min=""], [type=zoom][max=""]')&&((e=o[t].querySelector("[type=zoom]")).setAttribute("min",this._map.getMinZoom()),e.setAttribute("max",this._map.getMaxZoom())),(e=o[t].hasAttribute("units")?o[t].getAttribute("units"):null)&&M[e]?this._extent._mapExtents?this._extent._mapExtents[t].crs=M[e]:this._extent.crs=M[e]:this._extent._mapExtents?this._extent._mapExtents[t].crs=M.OSMTILE:this._extent.crs=M.OSMTILE}}},getProjection:function(){if(this._extent){let t=this._extent._mapExtents?this._extent._mapExtents[0]:this._extent;if(!t)return I;switch(t.tagName.toUpperCase()){case"MAP-EXTENT":if(t.hasAttribute("units"))return t.getAttribute("units").toUpperCase();break;case"MAP-INPUT":if(t.hasAttribute("value"))return t.getAttribute("value").toUpperCase();break;case"MAP-META":if(t.hasAttribute("content"))return M._metaContentToObject(t.getAttribute("content")).content.toUpperCase();break;default:return I}return I}},_parseLicenseAndLegend:function(t,e){var o,i=t.querySelector("map-link[rel=license]");i&&(o=i.getAttribute("title"),o='<a href="'+i.getAttribute("href")+'" title="'+o+'">'+o+"</a>"),L.setOptions(e,{attribution:o});t=t.querySelector("map-link[rel=legend]");t&&(e._legendUrl=t.getAttribute("href"))},getQueryTemplates:function(o){if(this._extent&&this._extent._queries){var i=[];if(this._layerEl.checked&&!this._layerEl.hidden&&this._mapmlLayerItem){var e=this._mapmlLayerItem.querySelectorAll(".mapml-layer-item-name");for(let t=0;t<e.length;t++)if(e[t].extent||1===this._extent._mapExtents.length){var n=e[t].extent||this._extent._mapExtents[0];for(let t=0;t<n._templateVars.length;t++)if(n.checked){var a=n._templateVars[t];for(let e=0;e<this._extent._queries.length;e++){let t=this._extent._queries[e];a===t&&t.extentBounds.contains(o)&&i.push(t)}}}return i}}},_attachSkipButtons:function(t){let n=t.popup,a=t.target,e,r,o=n._container.getElementsByClassName("mapml-popup-content")[0];n._container.setAttribute("role","dialog"),o.setAttribute("tabindex","-1"),o.setAttribute("role","document"),n._count=0,n._source._eventParents?(e=n._source._eventParents[Object.keys(n._source._eventParents)[0]],r=n._source.group,_.call(n)):(e=n._source._templatedLayer,a.on("attachZoomLink",_,n)),n._container.querySelector('nav[class="mapml-focus-buttons"]')&&(L.DomUtil.remove(n._container.querySelector('nav[class="mapml-focus-buttons"]')),L.DomUtil.remove(n._container.querySelector("hr")));var i=L.DomUtil.create("nav","mapml-focus-buttons");let s=L.DomUtil.create("button","mapml-popup-button",i);s.type="button",s.title="Focus Map",s.innerHTML="<span aria-hidden='true'>|&#10094;</span>",L.DomEvent.on(s,"click",t=>{L.DomEvent.stop(t),a.featureIndex._sortIndex(),a.closePopup(),a._container.focus()},n);let l=L.DomUtil.create("button","mapml-popup-button",i);l.type="button",l.title="Previous Feature",l.innerHTML="<span aria-hidden='true'>&#10094;</span>",L.DomEvent.on(l,"click",e._previousFeature,n);let m=L.DomUtil.create("p","mapml-feature-count",i),u=this._totalFeatureCount||1;m.innerText=n._count+1+"/"+u;let c=L.DomUtil.create("button","mapml-popup-button",i);c.type="button",c.title="Next Feature",c.innerHTML="<span aria-hidden='true'>&#10095;</span>",L.DomEvent.on(c,"click",e._nextFeature,n);let p=L.DomUtil.create("button","mapml-popup-button",i);p.type="button",p.title="Focus Controls",p.innerHTML="<span aria-hidden='true'>&#10095;|</span>",L.DomEvent.on(p,"click",t=>{a.featureIndex._sortIndex(),a.featureIndex.currentIndex=a.featureIndex.inBoundFeatures.length-1,a.featureIndex.inBoundFeatures[0].path.setAttribute("tabindex",-1),a.featureIndex.inBoundFeatures[a.featureIndex.currentIndex].path.setAttribute("tabindex",0),L.DomEvent.stop(t),a.closePopup(),a._controlContainer.querySelector("A:not([hidden])").focus()},n);t=L.DomUtil.create("hr","mapml-popup-divider");function h(t){let e=t.originalEvent.path||t.originalEvent.composedPath();var o=9===t.originalEvent.keyCode,i=t.originalEvent.shiftKey;(e[0].classList.contains("leaflet-popup-close-button")&&o&&!i||27===t.originalEvent.keyCode||e[0].classList.contains("leaflet-popup-close-button")&&13===t.originalEvent.keyCode||e[0].classList.contains("mapml-popup-content")&&o&&i||e[0]===n._content.querySelector("a")&&o&&i)&&setTimeout(()=>{a.closePopup(n),r.focus(),L.DomEvent.stop(t)},0)}function d(t){let e=t.originalEvent.path||t.originalEvent.composedPath();var o=9===t.originalEvent.keyCode,i=t.originalEvent.shiftKey;13===t.originalEvent.keyCode&&e[0].classList.contains("leaflet-popup-close-button")||27===t.originalEvent.keyCode?(L.DomEvent.stopPropagation(t),a.closePopup(n),a._container.focus(),27!==t.originalEvent.keyCode&&(a._popupClosed=!0)):o&&e[0].classList.contains("leaflet-popup-close-button")?a.closePopup(n):(e[0].classList.contains("mapml-popup-content")&&o&&i||e[0]===n._content.querySelector("a")&&o&&i)&&(a.closePopup(n),setTimeout(()=>{L.DomEvent.stop(t),a._container.focus()},0))}function _(e){let o=this._content,i=e?e.currFeature:this._source._groupLayer._featureEl;if(o.querySelector("a.mapml-zoom-link")&&o.querySelector("a.mapml-zoom-link").remove(),i.querySelector("map-geometry")){var n=i.extent.topLeft.gcrs,e=i.extent.bottomRight.gcrs,e=L.latLngBounds(L.latLng(n.horizontal,n.vertical),L.latLng(e.horizontal,e.vertical)).getCenter(!0);let t=document.createElement("a");t.href=`#${i.getMaxZoom()},${e.lng},`+e.lat,t.innerHTML=""+M.options.locale.popupZoom,t.className="mapml-zoom-link",t.onclick=t.onkeydown=function(t){(t instanceof MouseEvent||13===t.keyCode)&&(t.preventDefault(),i.zoomTo())},o.insertBefore(t,o.querySelector("hr.mapml-popup-divider"))}}n._navigationBar=i,n._content.appendChild(t),n._content.appendChild(i),o.focus(),r&&!M.options.featureIndexOverlayOption?(r.setAttribute("aria-expanded","true"),a.on("keydown",h)):a.on("keydown",d),a.on("popupclose",function t(e){e.popup===n&&(a.off("keydown",h),a.off("keydown",d),a.off("popupopen",_),a.off("popupclose",t),r&&r.setAttribute("aria-expanded","false"))})}}),b=L.Layer.extend({onAdd:function(t){var e=t.getSize();(400<e.x||300<e.y)&&(this._container=L.DomUtil.create("table","mapml-debug",t._container),this._panel=E({className:"mapml-debug-panel",pane:this._container}),t.addLayer(this._panel)),this._grid=A({className:"mapml-debug-grid",pane:t._panes.mapPane,zIndex:400,tileSize:t.options.crs.options.crs.tile.bounds.max.x}),t.addLayer(this._grid),this._vectors=S({className:"mapml-debug-vectors",pane:t._panes.mapPane,toolPane:this._container}),t.addLayer(this._vectors)},onRemove:function(t){t.removeLayer(this._grid),t.removeLayer(this._vectors),this._panel&&(t.removeLayer(this._panel),L.DomUtil.remove(this._container))}}),v=L.Layer.extend({initialize:function(t){L.setOptions(this,t)},onAdd:function(t){this._title=L.DomUtil.create("caption","mapml-debug-banner",this.options.pane),this._title.innerHTML="Debug mode",t.debug={},t.debug._infoContainer=this._debugContainer=L.DomUtil.create("tbody","mapml-debug-panel",this.options.pane);var e=t.debug._infoContainer;t.debug._tileCoord=L.DomUtil.create("tr","mapml-debug-coordinates",e),t.debug._tileMatrixCoord=L.DomUtil.create("tr","mapml-debug-coordinates",e),t.debug._mapCoord=L.DomUtil.create("tr","mapml-debug-coordinates",e),t.debug._tcrsCoord=L.DomUtil.create("tr","mapml-debug-coordinates",e),t.debug._pcrsCoord=L.DomUtil.create("tr","mapml-debug-coordinates",e),t.debug._gcrsCoord=L.DomUtil.create("tr","mapml-debug-coordinates",e),this._map.on("mousemove",this._updateCoords)},onRemove:function(){L.DomUtil.remove(this._title),this._debugContainer&&(L.DomUtil.remove(this._debugContainer),this._map.off("mousemove",this._updateCoords))},_updateCoords:function(s){if(!this.contextMenu._visible){let t=this.options.mapEl,e=t._map.project(s.latlng),o=t._map.options.crs.scale(+t.zoom),i=t._map.options.crs.transformation.untransform(e,o),n=t._map.options.crs.options.crs.tile.bounds.max.x,a=e.x%n,r=e.y%n;a<0&&(a+=n),r<0&&(r+=n),this.debug._tileCoord.innerHTML=`
